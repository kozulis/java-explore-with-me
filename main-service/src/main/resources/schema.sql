DROP TABLE IF EXISTS users, categories, events, requests, compilations, compilation_event, subscriptions CASCADE;

CREATE TABLE IF NOT EXISTS users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(254) UNIQUE NOT NULL,
    name VARCHAR(250) NOT NULL
    );

CREATE TABLE IF NOT EXISTS categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL
    );

CREATE TABLE IF NOT EXISTS events (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    annotation VARCHAR(2000) NOT NULL,
    category BIGINT NOT NULL REFERENCES categories(id),
    confirmed_request BIGINT,
    created_on TIMESTAMP WITHOUT TIME ZONE,
    description varchar(7000) NOT NULL,
    event_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    initiator BIGINT NOT NULL REFERENCES users(id) ON DELETE SET NULL,
    lat FLOAT NOT NULL,
    lon FLOAT NOT NULL,
    paid BOOLEAN NOT NULL DEFAULT false,
    participant_limit INT DEFAULT 0,
    published_on TIMESTAMP WITHOUT TIME ZONE,
    request_moderation BOOLEAN DEFAULT true,
    state VARCHAR(32) DEFAULT 'PENDING',
    title VARCHAR(120) NOT NULL
    );

CREATE TABLE IF NOT EXISTS requests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created TIMESTAMP WITHOUT TIME ZONE,
    event BIGINT REFERENCES events(id) ON DELETE CASCADE,
    requester BIGINT REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(32) DEFAULT 'PENDING'
);

CREATE TABLE IF NOT EXISTS compilations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    pinned BOOLEAN DEFAULT false,
    title VARCHAR(50) NOT NULL
);

CREATE TABLE IF NOT EXISTS compilation_event (
    event_id BIGINT REFERENCES events(id),
    compilation_id BIGINT REFERENCES compilations(id),
    PRIMARY KEY(event_id, compilation_id)
);

CREATE TABLE IF NOT EXISTS subscriptions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    initiator BIGINT REFERENCES users(id) ON DELETE CASCADE,
    user_for_subscribe BIGINT REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(16) DEFAULT 'WAITING'
);